services:
  # Unified sensor to MQTT service - replaces individual sensor services
  sensor2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: sensor2mqtt
    entrypoint: python /dfld/sensor2mqtt.py
    # High priority for sensor data collection
    cpu_shares: 1024
    environment:
      - DFLD_STATION_ID=${DFLD_REGION}-${DFLD_STATION}
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_DATA_TOPIC=dfld/sensors/noise/spl
      - MQTT_META_TOPIC=dfld/metadata/sensors
      - READOUT_INTERVAL_NOISE=1.0
      - READOUT_INTERVAL_AIR=60.0
      - RETRY_INTERVAL=120
      - LOG_LEVEL=INFO
      # DNMS Serial config
      - DNMS_DEVICE=${DEVICE_DNMS:-/dev/ttyDNMS}
      - DNMS_BAUDRATE=500000
      # DFLD Legacy config
      - AK_MODUL_DEVICE=${DEVICE_DFLD:-/dev/ttyUSB0}
      - AK_MODUL_BAUDRATE=9600
      # I2C config
      - DNMS_I2C_ADDRESS=0x55
      - BME280_I2C_ADDRESS=0x76
      - I2C_BUS=1
      - DNMS_MICROPHONE_TYPE=28
      # UDP config
      - UDP_LISTEN_PORT=11883
      # System metadata config
      - MQTT_META_SYSTEM_TOPIC=dfld/metadata/system
      - MQTT_META_GEO_TOPIC=dfld/metadata/geo
      - STATION_LAT=${STATION_LAT:-}
      - STATION_LON=${STATION_LON:-}
      - STATION_ALT=${STATION_ALT:-}
      - STATION_CITY=${STATION_CITY:-}
      - STARTUP_DELAY=30
    labels:
      - homepage.group=Infrastructure
      - homepage.name=sensor2mqtt
      - homepage.icon=/icons/thermometer-icon.svg
      - homepage.description=Unified sensor data collector
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_I2C}
{% if hw_conf["DFLD_DNMS_AVAILABLE"]==1 %}
      - ${DEVICE_DNMS}
{% endif %}
{% if hw_conf["DFLD_LEGACY_AVAILABLE"]==1 %}
      - ${DEVICE_DFLD}
{% endif %}
{% if hw_conf["DNMS_I2C_AVAILABLE"]==0 and hw_conf["DFLD_LEGACY_AVAILABLE"]==0 and hw_conf["DFLD_DNMS_AVAILABLE"]==0 %}
    # No hardware sensors detected, only UDP listener active
    ports:
      - 11883:11883/udp
{% endif %}
    # Required for hardware detection and access
    privileged: true

  mqtt2tsdb:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2tsdb
    entrypoint: python /dfld/mqtt2tsdb.py
    environment:
      - INFLUXDB_USERNAME=${INFLUX_ADMIN_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUX_ADMIN_PASSWORD}
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_SERVER=${INFLUXDB_SERVERNAME}:${INFLUXDB_SERVERPORT}
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=dfld/sensors/noise/spl/#
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2tsdb
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Push the data home
      - homepage.showStats=true
    networks:
      - network

{% if dfld_legacy is defined and dfld_legacy | length > 0 %}
  tsdb2ftp:
    image: dfld_box
    restart: unless-stopped
    container_name: tsdb2ftp
    entrypoint: python /dfld/tsdb2ftp.py
    environment:
      - INFLUXDB_USERNAME=${INFLUX_ADMIN_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUX_ADMIN_PASSWORD}
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_SERVER=${INFLUXDB_SERVERNAME}:${INFLUXDB_SERVERPORT}
      - INFLUXDB_MEASUREMENT=spl
      - DFLD_REGION=${DFLD_REGION}
      - DFLD_STATION=${DFLD_STATION}
      - DFLD_CKSUM=${DFLD_CKSUM}
      - DFLD_LEGACY=${DFLD_LEGACY}
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=tsdb2ftp
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Export data to FTP
      - homepage.showStats=true
    networks:
      - network

  mqtt2liveview:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2liveview
    entrypoint: python /dfld/mqtt2liveview.py
    environment:
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=dfld/sensors/noise/spl/#
      - DFLD_REGION=${DFLD_REGION}
      - DFLD_STATION=${DFLD_STATION}
      - DFLD_CKSUM=${DFLD_CKSUM}
      - DFLD_LIVEVIEW=${DFLD_LIVEVIEW}
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2liveview
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Send data to LiveView
      - homepage.showStats=true
    networks:
      - network
{% endif %}

{% if osm_station_id is defined and osm_station_id | length > 0 and osm_sensors is defined and osm_sensors | length > 0 and osm_api_key is defined and osm_api_key | length > 0 %}
  tsdb2osm:
    image: dfld_box
    restart: unless-stopped
    container_name: tsdb2osm
    entrypoint: python /dfld/tsdb2osm.py
    environment:
      - INFLUXDB_USERNAME=${INFLUX_ADMIN_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUX_ADMIN_PASSWORD}
      - INFLUXDB_SERVER=${INFLUXDB_SERVERNAME}:${INFLUXDB_SERVERPORT}
      - OSM_STATION_ID=${OSM_STATION_ID}
      - OSM_SENSORS=${OSM_SENSORS}
      - OSM_API_KEY=${OSM_API_KEY}
      - OSM_INTERVAL=${OSM_INTERVAL:-300}
      - OSM_API_URL=${OSM_API_URL:-https://api.opensensemap.org}
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=tsdb2osm
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Export data to openSenseMap
      - homepage.showStats=true
    networks:
      - network
{% endif %}

{% if mqtt_bridged_broker is defined and mqtt_bridged_broker | length > 0 and mqtt_bridged_rename is defined and mqtt_bridged_rename | length > 0 %}
  mqtt2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2mqtt
    entrypoint: python /dfld/mqtt2mqtt.py
    env_file:
      - ${DOCKER_EXTERNAL_ROOT}/ingress/dfld_user.env
    environment:
      - DFLD_STATION_ID=dfld-${DFLD_REGION}-${DFLD_STATION}
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_BRIDGED_BROKER=${MQTT_BRIDGED_BROKER}
      - MQTT_BRIDGED_RENAME=${MQTT_BRIDGED_RENAME}
      - MQTT_BRIDGED_TLS=${MQTT_BRIDGED_TLS}
      - LOG_LEVEL=INFO
    volumes:
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - ${DOCKER_EXTERNAL_ROOT}/mqtt-certs:/mqtt-certs:ro
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2mqtt
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Bridge to remote MQTT broker
      - homepage.showStats=true
    networks:
      - network
{% endif %}

{% if hw_conf["SSD1306_AVAILABLE"]==1 %}
  mqtt2display:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2display
    entrypoint: python /dfld/mqtt2display.py
    environment:
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=dfld/sensors/noise/spl/#
      - READOUT_INTERVAL=0.2
      - MQTT_READ_TIMEOUT=2.0
      - DISPLAY_TIMEOUT=2.0
      - PROCESS_EMPTY=1
      - I2C_BUS=1
      - SSD1306_I2C_ADDR=0x3C
      - SSD1306_WIDTH=128
      - SSD1306_HEIGHT=64
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2display
      - homepage.icon=/icons/microphone-voice-icon.svg
      - homepage.description=Display noise data on SSD1306
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_I2C}
    privileged: true
{% endif %}

networks:
    network:
        name: dfld_network
        external: true
