---

- name: Create ingress folder
  ansible.builtin.file:
    path: "{{ dfld_dir }}/ingress"
    owner: "{{ dfld_user_info.uid }}"
    group: "{{ dfld_user_info.group }}"
    state: directory
    mode: '0755'

- name: Copy env file to default location
  ansible.builtin.template:
    src: "templates/container/docker-compose.env.j2"
    dest: "{{ dfld_dir }}/ingress/docker-compose.env"
    owner: "{{ dfld_user_info.uid }}"
    group: "{{ dfld_user_info.group }}"
    mode: '0644'

- name: Generate ingress/dfld_user.env from dfld.yml
  ansible.builtin.command:
    cmd: /usr/local/bin/dfld-generate-env.sh {{ conf_dir }}/dfld.yml {{ dfld_dir }}/ingress/dfld_user.env {{ dfld_user_info.uid }}:{{ dfld_user_info.group }}
  register: generate_ingress_result
  changed_when: generate_ingress_result.rc == 0
  failed_when: generate_ingress_result.rc == 2

- name: Write docker compose file for ingress
  ansible.builtin.template:
    src: "templates/container/ingress-compose.yml.j2"
    dest: "{{ dfld_dir }}/ingress/docker-compose.yml"
    owner: "{{ dfld_user_info.uid }}"
    group: "{{ dfld_user_info.group }}"
    mode: '0644'

- name: Start ingress stack with docker compose
  community.docker.docker_compose_v2:
    project_src: "{{ dfld_dir }}/ingress"
    files:
      - "{{ dfld_dir }}/ingress/docker-compose.yml"
    env_files:
      - "{{ dfld_dir }}/ingress/dfld_user.env"
      - "{{ dfld_dir }}/ingress/docker-compose.env"
    state: present
    pull: never
    wait: true

- name: Create boot service for ingress
  ansible.builtin.copy:
    dest: /etc/systemd/system/dfld-ingress-reload.service
    content: |
      [Unit]
      Description=Reload DFLD Ingress Stack if config changed
      After=docker.service network-online.target
      Requires=docker.service
      Wants=network-online.target

      [Service]
      Type=oneshot
      WorkingDirectory={{ dfld_dir }}/ingress
      ExecStart=/bin/bash -c '\
        if /usr/local/bin/dfld-generate-env.sh {{ conf_dir }}/dfld.yml {{ dfld_dir }}/ingress/dfld_user.env {{ dfld_user_info.uid }}:{{ dfld_user_info.group }}; then \
          echo "Environment file was updated, reloading containers..."; \
          /usr/bin/docker compose -f {{ dfld_dir }}/ingress/docker-compose.yml --env-file {{ dfld_dir }}/ingress/dfld_user.env --env-file {{ dfld_dir }}/ingress/docker-compose.env up -d --force-recreate; \
        else \
          echo "Environment file is up to date, no reload needed"; \
        fi'

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: '0644'

- name: Enable ingress boot service
  ansible.builtin.systemd:
    name: dfld-ingress-reload.service
    enabled: true
    daemon_reload: true
