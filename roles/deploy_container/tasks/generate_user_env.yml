---
# Generate dfld_user.env from dfld.yml before first container deployment

- name: Check if dfld.yml exists
  ansible.builtin.stat:
    path: "{{ conf_dir }}/dfld.yml"
  register: dfld_yml_stat

- name: Generate dfld_user.env from dfld.yml
  ansible.builtin.shell: |
    yq e '. | to_entries | .[] | "\(.key | upcase)=\(.value)"' {{ conf_dir }}/dfld.yml > {{ dfld_dir }}/dfld_user.env
  args:
    executable: /bin/bash
  when: dfld_yml_stat.stat.exists
  changed_when: true

- name: Set proper permissions for dfld_user.env
  ansible.builtin.file:
    path: "{{ dfld_dir }}/dfld_user.env"
    owner: "{{ dfld_user_info.uid }}"
    group: "{{ dfld_user_info.group }}"
    mode: '0644'
  when: dfld_yml_stat.stat.exists
