---

- name: Detect hardware on Raspberry Pi
  # when: ansible_facts.architecture == 'aarch64'
  block:
    - name: Run hardware detection in docker container
      ansible.builtin.command: docker run --rm --privileged -v /dev:/dev:ro dfld_box python detect_hw.py
      register: detect_hw_response
      changed_when: false

    - name: Extract hardware config to json fact
      ansible.builtin.set_fact:
        hw_conf: "{{ detect_hw_response.stdout | from_json }}"

  rescue:
    - name: Set default hardware config
      ansible.builtin.set_fact:
        hw_conf:
          BME280_AVAILABLE: 0
          SSD1306_AVAILABLE: 0
          
          DFLD_DNMS_AVAILABLE: 0
          DFLD_LEGACY_AVAILABLE: 0
          DNMS_I2C_AVAILABLE: 0
          ADSB_AVAILABLE: 0

- name: Check if dfld.yml exists on target system
  ansible.builtin.stat:
    path: "{{ conf_dir }}/dfld.yml"
  register: remote_dfld_yml

- name: Check if dfld.yml exists locally
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/dfld.yml"
  register: local_dfld_yml
  delegate_to: localhost
  become: false
  when: not remote_dfld_yml.stat.exists

- name: Copy local dfld.yml to target system
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/dfld.yml"
    dest: "{{ conf_dir }}/dfld.yml"
    owner: root
    group: root
    mode: '0644'
  when: 
    - not remote_dfld_yml.stat.exists
    - local_dfld_yml.stat.exists

- name: Read station configuration from target system
  ansible.builtin.slurp:
    src: "{{ conf_dir }}/dfld.yml"
  register: dfld_config_file

- name: Parse dfld.yml content
  ansible.builtin.set_fact:
    dfld_config: "{{ dfld_config_file.content | b64decode | from_yaml }}"

- name: Flatten dfld_config into top-level facts
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  loop: "{{ dfld_config | dict2items }}"
