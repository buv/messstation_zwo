services:
{% if hw_conf["DFLD_DNMS_AVAILABLE"]==1 %}
  dnms2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: dnms2mqtt
    entrypoint: python /dfld/dnms2mqtt.py
    env_file:
      - /boot/firmware/adsb.env
      - /boot/firmware/dfld.env
    environment:
      - DEVICE=${DEVICE_DNMS}
      - DNMS_BAUDRATE=500000
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/noise/spl
      - READOUT_INTERVAL=0.0
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=dnms2influx
      - homepage.icon=/icons/microphone-voice-icon.svg
      - homepage.description=We get the noise
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_DNMS}
    # device_cgroup_rules:
    #   - 'c 166:* rmw'  # for /dev/ttyDNMS
    #   - 'c 188:* rmw'  # for /dev/ttyACM0
{% endif %}

{% if hw_conf["DFLD_LEGACY_AVAILABLE"]==1 %}
  dfld2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: dfld2mqtt
    entrypoint: python /dfld/dfld2mqtt.py
    env_file:
      - /boot/firmware/adsb.env
      - /boot/firmware/dfld.env
    environment:
      - DEVICE=${DEVICE_DFLD}
      - DFLD_BAUDRATE=9600
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/noise/spl
      - READOUT_INTERVAL=0.0
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=dnms2mqtt
      - homepage.icon=https://www.dfld.de/Basics/images/Logo-DFLD.svg
      - homepage.description=Fancy legacy stuff
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_DFLD}
{% endif %}

{% if hw_conf["DNMS_I2C_AVAILABLE"]==1 %}
  dnmsiic2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: dnmsiic2mqtt
    entrypoint: python /dfld/dnmsiic2mqtt.py
    env_file:
      - /boot/firmware/adsb.env
      - /boot/firmware/dfld.env
    environment:
      - DNMS_I2C_ADDRESS=0x55
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/noise/spl
      - READOUT_INTERVAL=1.0
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=dnmsiic2mqtt
      - homepage.icon=/icons/processor-icon.svg
      - homepage.description=We get the noise
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_I2C}
{% endif %}

{% if hw_conf["BME280_AVAILABLE"]==1 %}
  bme2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: bme2mqtt
    entrypoint: python /dfld/bme2mqtt.py
    environment:
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/air
      - READOUT_INTERVAL=60
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=bme2mqtt
      - homepage.icon=/icons/thermometer-icon.svg
      - homepage.description=We get the noise
      - homepage.showStats=true
    networks:
      - network
    devices:
      - ${DEVICE_I2C}
{% endif %}

{% if dfld_legacy | length != 0 %}
  tsdb2ftp:
    image: dfld_box
    restart: unless-stopped
    container_name: tsdb2ftp
    entrypoint: python /dfld/tsdb2ftp.py
    env_file:
      - /boot/firmware/adsb.env
      - /boot/firmware/dfld.env
    environment:
      - INFLUXDB_USERNAME=${INFLUX_ADMIN_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUX_ADMIN_PASSWORD}
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_SERVER=${INFLUXDB_SERVERNAME}:${INFLUXDB_SERVERPORT}
      - INFLUXDB_MEASUREMENT=spl
      - DFLD_REGION=${DFLD_REGION}
      - DFLD_STATION=${DFLD_STATION}
      - DFLD_CKSUM=${DFLD_CKSUM}
      - DFLD_LEGACY=${DFLD_LEGACY}
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=tsdb2ftp
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Push the data home
      - homepage.showStats=true
    networks:
      - network

  mqtt2liveview:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2liveview
    entrypoint: python /dfld/mqtt2liveview.py
    env_file:
      - /boot/firmware/adsb.env
      - /boot/firmware/dfld.env
    environment:
      - DFLD_REGION=${DFLD_REGION}
      - DFLD_STATION=${DFLD_STATION}
      - DFLD_CKSUM=${DFLD_CKSUM}
      - DFLD_LEGACY=${DFLD_LEGACY}
      - DFLD_LIVEVIEW=${DFLD_LIVEVIEW}
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/noise/spl
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2liveview
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Push the data home
      - homepage.showStats=true
    networks:
      - network
{% endif %}

{% if hw_conf["DNMS_I2C_AVAILABLE"]==0 and hw_conf["DFLD_LEGACY_AVAILABLE"]==0  and hw_conf["DFLD_DNMS_AVAILABLE"]==0 %}
  udp2mqtt:
    image: dfld_box
    restart: unless-stopped
    container_name: udp2mqtt
    entrypoint: python /dfld/udp2mqtt.py
    environment:
      - UDP_LISTEN_PORT=11883
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/noise/spl
      - READOUT_INTERVAL=0.0
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=udp2mqtt
      - homepage.icon=/icons/thermometer-icon.svg
      - homepage.description=We get the noise
      - homepage.showStats=true
    ports:
      - 11883:11883/udp
    networks:
      - network
{% endif %}

  mqtt2tsdb:
    image: dfld_box
    restart: unless-stopped
    container_name: mqtt2tsdb
    entrypoint: python /dfld/mqtt2tsdb.py
    environment:
      - INFLUXDB_USERNAME=${INFLUX_ADMIN_USERNAME}
      - INFLUXDB_PASSWORD=${INFLUX_ADMIN_PASSWORD}
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_SERVER=${INFLUXDB_SERVERNAME}:${INFLUXDB_SERVERPORT}
      - MQTT_SERVER=${MQTT_SERVER}
      - MQTT_TOPIC=/dfld/sensors/#
      - TZ=${TZ}
      - LOG_LEVEL=INFO
    labels:
      - homepage.group=Infrastructure
      - homepage.name=mqtt2tsdb
      - homepage.icon=/icons/server-upload-icon.svg
      - homepage.description=Push the data home
      - homepage.showStats=true
    networks:
      - network

networks:
    network:
        name: dfld_network
        external: true
